<!DOCTYPE html>
<html>
<head>
  <title>System Metrics</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      background: #f0f0f0;
      color: #333;
    }
    #charts {
      display: flex;
      flex-wrap: wrap;
      gap: 2em;
    }
    .chart-box {
      background: white;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      width: 27%;
    }
    h1 {
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <h1>Live System Monitoring</h1>
  <div id="charts">
    <div class="chart-box">
      <h3>Temperature (Â°C)</h3>
      <div id="cpu_temp_gauge"></div>
    </div>
    <div class="chart-box">
      <h3>Atm. Pressure</h3>
      <div id="drive_temp_gauge"></div>
    </div>
    <div class="chart-box">
      <h3>Humidity</h3>
      <div id="pch_temp_gauge"></div>
    </div>
    <div class="chart-box" style="width: 100%;">
      <h3>Temperature Over Time</h3>
      <div id="temp_chart" style="width: 100%; height: 300px;"></div>
      <h3>Pressure Over Time</h3>
      <div id="pressure_chart" style="width: 100%; height: 300px;"></div>
      <h3>Humidity Over Time</h3>
      <div id="humidity_chart" style="width: 100%; height: 300px;"></div>
    </div>
  </div>

  <script>
    google.charts.load('current', {'packages':['gauge', 'corechart']});
    google.charts.setOnLoadCallback(startMonitoring);

    let tempGauge, pressureGauge, humidityGauge, lineChart1, lineChart2, lineChart3;
    let tempGaugeData, pressureGaugeData, humidityGaugeData, lineChartData1, lineChartData2, lineChartData3;
    let tempGaugeOptions = { min: 0, max: 100, redFrom: 80, yellowFrom: 60, minorTicks: 5 };
    let pressureGaugeOptions = { min: 0, max: 80, redFrom: 60, yellowFrom: 45, minorTicks: 5 };
    let humidityGaugeOptions = { min: 0, max: 80, redFrom: 60, yellowFrom: 45, minorTicks: 5 };

    function drawCharts(metrics) {
      let tempData = new google.visualization.DataTable();
	  tempData.addColumn('datetime', 'Time');
	  tempData.addColumn('number', 'Temperature');
      let pressureData = new google.visualization.DataTable();
	  pressureData.addColumn('datetime', 'Time');
	  pressureData.addColumn('number', 'Pressure');
      let humidityData = new google.visualization.DataTable();
	  humidityData.addColumn('datetime', 'Time');
	  humidityData.addColumn('number', 'Humidity');
	  //
	  let data = metrics.data;
      const temperature = metrics.recent ? 1.0*metrics.recent.temp : data[0].temp;
      const pressure = metrics.recent ? 1.0*metrics.recent.prs : data[0].pres;
      const humidity = metrics.recent ? 1.0*metrics.recent.hum : data[0].humd;

      // Update line chart dataset
	  for (let i = 0 ; i < data.length; i++) {
        tempData.addRow([new Date(data[i].endtime), data[i].temp]);
        pressureData.addRow([new Date(data[i].endtime), data[i].pres]);
        humidityData.addRow([new Date(data[i].endtime), data[i].humd]);
	  }

      // Gauges
      tempGaugeData = google.visualization.arrayToDataTable([
        ['Label', 'Value'],
        ['Temperature', temperature]
      ]);
      pressureGaugeData = google.visualization.arrayToDataTable([
        ['Label', 'Value'],
        ['Pressure', pressure]
      ]);
      humidityGaugeData = google.visualization.arrayToDataTable([
        ['Label', 'Value'],
        ['Humidity', humidity]
      ]);

      if (!tempGauge) {
        tempGauge = new google.visualization.Gauge(document.getElementById('cpu_temp_gauge'));
        pressureGauge = new google.visualization.Gauge(document.getElementById('drive_temp_gauge'));
        humidityGauge = new google.visualization.Gauge(document.getElementById('pch_temp_gauge'));
      }
      tempGauge.draw(tempGaugeData, tempGaugeOptions);
      pressureGauge.draw(pressureGaugeData, pressureGaugeOptions);
      humidityGauge.draw(humidityGaugeData, humidityGaugeOptions);

      // Line Chart
      if (!lineChart1) lineChart1 = new google.visualization.LineChart(document.getElementById('temp_chart'));
      lineChart1.draw(tempData, {
        curveType: 'function',
        legend: 'none',
        hAxis: { format: 'HH:mm' }
      });
	  //
      if (!lineChart2) lineChart2 = new google.visualization.LineChart(document.getElementById('pressure_chart'));
      lineChart2.draw(pressureData, {
        curveType: 'function',
        legend: 'none',
        hAxis: { format: 'HH:mm' }
      });
	  //
      if (!lineChart3) lineChart3 = new google.visualization.LineChart(document.getElementById('humidity_chart'));
      lineChart3.draw(humidityData, {
        curveType: 'function',
        legend: 'none',
        hAxis: { format: 'HH:mm' }
      });
	  //
    }

    function fetchMetrics() {
      fetch('/data?device=c987fad0-d518-4c52-a7e2-78fcf5f3df3b')
        .then(res => res.json())
        .then(data => drawCharts(data))
        .catch(err => console.error('Error fetching metrics:', err));
    }

    function startMonitoring() {
      fetchMetrics();
      setInterval(fetchMetrics, 1000); // every 5 seconds
    }
  </script>
</body>
</html>
