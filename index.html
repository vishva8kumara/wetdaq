<!DOCTYPE html>
<html>
<head>
  <title>System Metrics</title>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 2em;
      background: #f0f0f0;
      color: #333;
    }
    #charts {
      display: flex;
      flex-wrap: wrap;
      gap: 2em;
    }
    .chart-box {
      background: white;
      padding: 1em;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      width: 27%;
    }
    h1 {
      margin-bottom: 1em;
    }
  </style>
</head>
<body>
  <h1>Live System Monitoring</h1>
  <div id="charts">
    <div class="chart-box">
      <h3>Temperature (°C)</h3>
      <div id="cpu_temp_gauge"></div>
    </div>
    <div class="chart-box">
      <h3>Atm. Pressure</h3>
      <div id="drive_temp_gauge"></div>
    </div>
    <div class="chart-box">
      <h3>Humidity</h3>
      <div id="pch_temp_gauge"></div>
    </div>
    <div class="chart-box" style="width: 100%;">
      <h3>Parameters Over Time</h3>
      <div id="temp_chart" style="width: 100%; height: 300px;"></div>
    </div>
  </div>

  <script>
    google.charts.load('current', {'packages':['gauge', 'corechart']});
    google.charts.setOnLoadCallback(startMonitoring);

    let tempGauge, pressureGauge, humidityGauge, lineChart;
    let tempGaugeData, pressureGaugeData, humidityGaugeData, lineChartData;
    let tempGaugeOptions = { min: 0, max: 100, redFrom: 80, yellowFrom: 60, minorTicks: 5 };
    let pressureGaugeOptions = { min: 0, max: 80, redFrom: 60, yellowFrom: 45, minorTicks: 5 };
    let humidityGaugeOptions = { min: 0, max: 80, redFrom: 60, yellowFrom: 45, minorTicks: 5 };

    function drawCharts(metrics) {
      let tempData = [['Time', 'Temperature', 'Atm. Pressure', 'Humidity']];
      const temperature = metrics[0].temp || 0;
      const pressure = metrics[0].pres || 0;
      const humidity = metrics[0].humd || 0;

      // Update line chart dataset
	  for (let i = 0 ; i < metrics.length; i++)
        tempData.push([metrics[i].endtime, metrics[i].temp, metrics[i].pres/10, metrics[i].humd]);

      // Gauges
      tempGaugeData = google.visualization.arrayToDataTable([
        ['Label', 'Value'],
        ['Temperature', temperature]
      ]);
      pressureGaugeData = google.visualization.arrayToDataTable([
        ['Label', 'Value'],
        ['Pressure', pressure]
      ]);
      humidityGaugeData = google.visualization.arrayToDataTable([
        ['Label', 'Value'],
        ['Humidity', humidity]
      ]);

      if (!tempGauge) {
        tempGauge = new google.visualization.Gauge(document.getElementById('cpu_temp_gauge'));
        pressureGauge = new google.visualization.Gauge(document.getElementById('drive_temp_gauge'));
        humidityGauge = new google.visualization.Gauge(document.getElementById('pch_temp_gauge'));
      }
      tempGauge.draw(tempGaugeData, tempGaugeOptions);
      pressureGauge.draw(pressureGaugeData, pressureGaugeOptions);
      humidityGauge.draw(humidityGaugeData, humidityGaugeOptions);

      // Line Chart
      lineChartData = google.visualization.arrayToDataTable(tempData);
      if (!lineChart) lineChart = new google.visualization.LineChart(document.getElementById('temp_chart'));
      lineChart.draw(lineChartData, {
        //title: 'Weather Over Time',
        curveType: 'function',
        legend: { position: 'bottom' },
        hAxis: { title: 'Time' },
        //vAxis: { title: 'Temperature (°C)', minValue: 0, maxValue: 100 }
      });
    }

    function fetchMetrics() {
      fetch('/data')
        .then(res => res.json())
        .then(data => drawCharts(data))
        .catch(err => console.error('Error fetching metrics:', err));
    }

    function startMonitoring() {
      fetchMetrics();
      setInterval(fetchMetrics, 5000); // every 5 seconds
    }
  </script>
</body>
</html>
